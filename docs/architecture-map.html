<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ThermoCrypt Lite v1.0.0 ‚Äî System Architecture</title>
    <script>
        window.addEventListener('error', e => {
            if (e.message === 'ResizeObserver loop completed with undelivered notifications.') {
                e.stopImmediatePropagation();
            }
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --bg-root: #0a0e17;
            --bg-panel: #0f1419;
            --bg-card: #151c25;
            --text-main: #e8edf4;
            --text-muted: #8b99ad;
            --text-dim: #5a6a7e;
            --accent: #00d4ff;
            --accent-glow: rgba(0, 212, 255, 0.3);
            --border: #1e2a3a;
            --border-glow: rgba(0, 212, 255, 0.15);
            
            /* Node Colors */
            --node-mem: #ff4757;
            --node-crypto: #9c5fff;
            --node-io: #00d26a;
            --node-core: #ffb347;
            --node-security: #ff6b9d;
            
            /* Fonts */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-sans);
            background: var(--bg-root);
            color: var(--text-main);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
        }

        /* === NETWORK CANVAS === */
        #network {
            flex: 1;
            background: 
                radial-gradient(ellipse at 30% 20%, rgba(0, 212, 255, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(156, 95, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at center, #111822 0%, #0a0e17 100%);
            position: relative;
        }

        /* Floating Title */
        #canvas-title {
            position: absolute;
            top: 25px;
            left: 30px;
            z-index: 5;
            pointer-events: none;
        }
        #canvas-title h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }
        #canvas-title span {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 0.5px;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 25px;
            left: 30px;
            z-index: 5;
            display: flex;
            gap: 20px;
            background: rgba(15, 20, 25, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 8px currentColor;
        }

        /* === DETAILS PANEL === */
        #details-panel {
            width: 480px;
            height: 100vh;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: -10px 0 40px rgba(0,0,0,0.5);
        }

        /* Panel Header */
        #panel-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(15, 20, 25, 1) 0%, rgba(15, 20, 25, 0.95) 100%);
            backdrop-filter: blur(10px);
        }
        #panel-header span {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-dim);
        }
        #close-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        #close-btn:hover { color: #fff; }

        /* Panel Content */
        #content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        #content::-webkit-scrollbar { width: 6px; }
        #content::-webkit-scrollbar-track { background: transparent; }
        #content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Intro State */
        #intro-msg {
            padding: 60px 30px;
            text-align: center;
        }
        #intro-msg h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 15px;
        }
        #intro-msg p {
            color: var(--text-muted);
            line-height: 1.7;
            max-width: 320px;
            margin: 0 auto 30px auto;
        }
        .intro-legend {
            text-align: left;
            display: inline-block;
        }
        .intro-legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* === DETAIL VIEW === */
        #detail-view {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .detail-header {
            padding: 30px;
            background: linear-gradient(180deg, var(--bg-card) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
        }
        .detail-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        /* Tags */
        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .tag-mem { background: rgba(255, 71, 87, 0.15); color: #ff6b7a; border: 1px solid rgba(255, 71, 87, 0.3); }
        .tag-crypto { background: rgba(156, 95, 255, 0.15); color: #b794ff; border: 1px solid rgba(156, 95, 255, 0.3); }
        .tag-io { background: rgba(0, 210, 106, 0.15); color: #5fffab; border: 1px solid rgba(0, 210, 106, 0.3); }
        .tag-core { background: rgba(255, 179, 71, 0.15); color: #ffc978; border: 1px solid rgba(255, 179, 71, 0.3); }
        .tag-security { background: rgba(255, 107, 157, 0.15); color: #ff8fb3; border: 1px solid rgba(255, 107, 157, 0.3); }

        /* Content Sections */
        .detail-body { padding: 25px 30px; }

        .section {
            margin-bottom: 25px;
        }
        .section-title {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-title::before {
            content: '';
            width: 3px;
            height: 12px;
            background: var(--accent);
            border-radius: 2px;
        }

        .section p {
            color: var(--text-muted);
            line-height: 1.75;
            font-size: 0.92rem;
            margin-bottom: 12px;
        }
        .section ul, .section ol {
            color: var(--text-muted);
            padding-left: 20px;
            line-height: 1.8;
            font-size: 0.92rem;
        }
        .section li { margin-bottom: 8px; }
        .section strong { color: var(--text-main); }
        .section code {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.85em;
        }

        /* Code Block */
        .code-block {
            background: #0c1016;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 18px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            line-height: 1.7;
            color: #a0b3c8;
            overflow-x: auto;
            margin: 15px 0;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
        }
        .code-block .kw { color: #ff7b72; }
        .code-block .fn { color: #d2a8ff; }
        .code-block .cm { color: #6b7d8f; font-style: italic; }
        .code-block .str { color: #a5d6ff; }
        .code-block .num { color: #79c0ff; }

        /* Warning Box */
        .warning-box {
            background: rgba(255, 179, 71, 0.08);
            border: 1px solid rgba(255, 179, 71, 0.25);
            border-left: 3px solid var(--node-core);
            border-radius: 8px;
            padding: 14px 18px;
            margin: 15px 0;
        }
        .warning-box p {
            color: #ffc978 !important;
            font-size: 0.88rem !important;
            margin: 0 !important;
        }

        /* Security Box */
        .security-box {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 8px;
            padding: 14px 18px;
            margin: 15px 0;
        }
        .security-box .label {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .security-box p {
            color: var(--text-muted) !important;
            margin: 0 !important;
        }

        /* === MOBILE === */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            #network { width: 100%; height: 100vh; position: absolute; }
            #canvas-title { top: 15px; left: 15px; }
            #legend { bottom: auto; top: 15px; right: 15px; left: auto; flex-direction: column; gap: 8px; padding: 10px 14px; }
            #details-panel {
                width: 100%; height: 80vh; position: absolute; bottom: 0;
                border-left: none; border-top: 1px solid var(--accent);
                transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 20px 20px 0 0;
            }
            #details-panel.open { transform: translateY(0); }
            #close-btn { display: block; }
            #intro-msg { padding: 40px 25px; }
        }
    </style>
</head>
<body>

    <!-- NETWORK CANVAS -->
    <div id="network">
        <div id="canvas-title">
            <h1>ThermoCrypt Lite</h1>
            <span>Interactive Architecture Map ‚Äî v1.0.0</span>
        </div>
        <div id="legend">
            <div class="legend-item"><span class="legend-dot" style="color: var(--node-mem)"></span> Memory</div>
            <div class="legend-item"><span class="legend-dot" style="color: var(--node-crypto)"></span> Crypto</div>
            <div class="legend-item"><span class="legend-dot" style="color: var(--node-io)"></span> I/O</div>
            <div class="legend-item"><span class="legend-dot" style="color: var(--node-core)"></span> Workflow</div>
            <div class="legend-item"><span class="legend-dot" style="color: var(--node-security)"></span> Security</div>
        </div>
    </div>

    <!-- DETAILS PANEL -->
    <div id="details-panel">
        <div id="panel-header">
            <span>Component Inspector</span>
            <button id="close-btn" onclick="closePanel()">&times;</button>
        </div>
        <div id="content">
            <!-- Intro State -->
            <div id="intro-msg">
                <h1>üîç Architecture Explorer</h1>
                <p>Click any node in the diagram to inspect its implementation details, security properties, and source code.</p>
                <div class="intro-legend">
                    <div class="intro-legend-item">
                        <span class="legend-dot" style="color: var(--node-mem); width:12px; height:12px;"></span>
                        Memory Hygiene Layer
                    </div>
                    <div class="intro-legend-item">
                        <span class="legend-dot" style="color: var(--node-crypto); width:12px; height:12px;"></span>
                        Cryptographic Engine
                    </div>
                    <div class="intro-legend-item">
                        <span class="legend-dot" style="color: var(--node-io); width:12px; height:12px;"></span>
                        I/O & File System
                    </div>
                    <div class="intro-legend-item">
                        <span class="legend-dot" style="color: var(--node-core); width:12px; height:12px;"></span>
                        Application Workflows
                    </div>
                    <div class="intro-legend-item">
                        <span class="legend-dot" style="color: var(--node-security); width:12px; height:12px;"></span>
                        Security Policies
                    </div>
                </div>
            </div>

            <!-- Detail View (hidden by default) -->
            <div id="detail-view">
                <div class="detail-header">
                    <h1 id="detail-title">Component Name</h1>
                    <div class="tags" id="detail-tags"></div>
                </div>
                <div class="detail-body" id="detail-body"></div>
            </div>
        </div>
    </div>

    <!-- Load vis-network from multiple CDNs with fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.9/vis-network.min.js"></script>
    <script>
        // Fallback if first CDN fails
        if (typeof vis === 'undefined') {
            document.write('<script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"><\/script>');
        }
    </script>
    <script>
        // Check if vis loaded
        if (typeof vis === 'undefined') {
            document.getElementById('network').innerHTML = '<div style="padding:50px;text-align:center;color:#ff6b7a;"><h2>‚ö†Ô∏è Failed to load visualization library</h2><p>Please check your internet connection and refresh the page.</p></div>';
            throw new Error('vis-network library failed to load');
        }

        // === NODE DEFINITIONS ===
        const nodes = new vis.DataSet([
            // CORE
            { id: 1, label: "ThermoCrypt\nCore", shape: "hexagon", size: 58, color: { background: "#00d4ff", border: "#00a8cc" }, font: { size: 16, color: "#fff", strokeWidth: 2, strokeColor: "#000" } },
            { id: 2, label: "GUI\n(Python)", shape: "box", size: 25, color: { background: "#1e2a3a", border: "#3d4f63" }, font: { color: "#8b99ad" } },

            // MEMORY (RED)
            { id: 10, label: "Memory\nHygiene", shape: "diamond", size: 42, color: { background: "#2a1520", border: "#ff4757" }, font: { color: "#ff6b7a" } },
            { id: 11, label: "SodiumAllocator", group: "mem" },
            { id: 12, label: "SecretString", group: "mem" },
            { id: 13, label: "SecureVectorStream", group: "mem" },
            { id: 14, label: "mlock / VirtualLock", group: "mem" },

            // CRYPTO (PURPLE)
            { id: 20, label: "Hybrid\nCrypto", shape: "diamond", size: 42, color: { background: "#1f1530", border: "#9c5fff" }, font: { color: "#b794ff" } },
            { id: 21, label: "ML-KEM-768\n(Kyber)", group: "crypto" },
            { id: 22, label: "X25519\n(ECDH)", group: "crypto" },
            { id: 23, label: "ML-DSA-65\n(Dilithium)", group: "crypto" },
            { id: 24, label: "KDF Mix\n(BLAKE2b)", group: "crypto" },
            { id: 25, label: "XChaCha20\nPoly1305", group: "crypto" },
            { id: 26, label: "Argon2id", group: "crypto" },

            // IO (GREEN)
            { id: 30, label: "Secure\nI/O", shape: "diamond", size: 42, color: { background: "#0f2518", border: "#00d26a" }, font: { color: "#5fffab" } },
            { id: 31, label: "TOCTOU\nDefense", group: "io" },
            { id: 32, label: "ASCII Armor", group: "io" },
            { id: 33, label: "Identity File\n(.thermoid)", group: "io" },
            { id: 34, label: "Vault File\n(.vault)", group: "io" },

            // WORKFLOW (ORANGE)
            { id: 40, label: "Generate\nIdentity", group: "core" },
            { id: 41, label: "TPM\nBinding", group: "core" },
            { id: 42, label: "Encrypt\nMessage", group: "core" },
            { id: 43, label: "Decrypt\nMessage", group: "core" },

            // SECURITY POLICIES (PINK)
            { id: 50, label: "Security\nPolicies", shape: "diamond", size: 42, color: { background: "#2a1525", border: "#ff6b9d" }, font: { color: "#ff8fb3" } },
            { id: 51, label: "Password\nPolicy", group: "security" },
            { id: 52, label: "DoS\nProtection", group: "security" },
            { id: 53, label: "Dependency\nVerification", group: "security" },
        ]);

        // === EDGE DEFINITIONS ===
        const edges = new vis.DataSet([
            // GUI to Core
            { from: 2, to: 1, arrows: "to", label: "pipes", dashes: true, font: { size: 10, color: "#5a6a7e" }, color: { color: "#3d4f63" } },

            // Core to Layers
            { from: 1, to: 10, width: 2, color: { color: "#ff4757", opacity: 0.6 } },
            { from: 1, to: 20, width: 2, color: { color: "#9c5fff", opacity: 0.6 } },
            { from: 1, to: 30, width: 2, color: { color: "#00d26a", opacity: 0.6 } },
            { from: 1, to: 50, width: 2, color: { color: "#ff6b9d", opacity: 0.6 } },

            // Core to Workflows
            { from: 1, to: 40, arrows: "to", color: { color: "#ffb347" } },
            { from: 1, to: 42, arrows: "to", color: { color: "#ffb347" } },
            { from: 1, to: 43, arrows: "to", color: { color: "#ffb347" } },

            // Memory Internal
            { from: 10, to: 11 }, { from: 10, to: 12 }, { from: 10, to: 13 }, { from: 10, to: 14 },
            { from: 11, to: 12, label: "backs", font: { size: 9, color: "#5a6a7e" } },

            // Crypto Internal
            { from: 20, to: 21 }, { from: 20, to: 22 }, { from: 20, to: 23 }, { from: 20, to: 25 }, { from: 20, to: 26 },
            { from: 21, to: 24, arrows: "to", label: "SS‚ÇÅ", font: { size: 9, color: "#5a6a7e" } },
            { from: 22, to: 24, arrows: "to", label: "SS‚ÇÇ", font: { size: 9, color: "#5a6a7e" } },
            { from: 24, to: 25, arrows: "to", label: "key", font: { size: 9, color: "#5a6a7e" } },

            // IO Internal
            { from: 30, to: 31 }, { from: 30, to: 32 }, { from: 30, to: 33 }, { from: 30, to: 34 },
            { from: 31, to: 33, label: "guards", font: { size: 9, color: "#5a6a7e" } },
            { from: 31, to: 34, label: "guards", font: { size: 9, color: "#5a6a7e" } },

            // Security Policies Internal
            { from: 50, to: 51 }, { from: 50, to: 52 }, { from: 50, to: 53 },

            // Workflow Connections
            { from: 40, to: 41 },
            { from: 40, to: 23, label: "sign", font: { size: 9, color: "#5a6a7e" } },
            { from: 40, to: 11, label: "alloc", font: { size: 9, color: "#5a6a7e" } },
            { from: 40, to: 51, label: "enforce", font: { size: 9, color: "#5a6a7e" } },
            { from: 41, to: 34, label: "write", font: { size: 9, color: "#5a6a7e" } },
            { from: 42, to: 13, label: "stream", font: { size: 9, color: "#5a6a7e" } },
            { from: 42, to: 20 },
            { from: 42, to: 32 },
            { from: 42, to: 52, label: "limit", font: { size: 9, color: "#5a6a7e" } },
            { from: 43, to: 34, label: "read", font: { size: 9, color: "#5a6a7e" } },
            { from: 43, to: 20 },
            { from: 26, to: 34, label: "seal", font: { size: 9, color: "#5a6a7e" } },
        ]);

        // === CONTENT DATABASE ===
        const detailsMap = {
            1: {
                title: "ThermoCrypt Core",
                tags: [{ text: "C++17", type: "core" }, { text: "Entry Point", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Architecture Overview</div>
                        <p>The <code>thermo_core</code> binary is the hardened cryptographic kernel. It operates under the assumption that the environment is hostile ‚Äî including the possibility of memory forensics or a compromised OS.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Initialization Sequence</div>
                        <p>Before parsing any user input, <code>main()</code> executes a strict lockdown:</p>
                        <div class="code-block"><span class="cm">// 1. Lock RAM (Anti-Swap)</span>
<span class="fn">mlockall</span>(MCL_CURRENT | MCL_FUTURE);

<span class="cm">// 2. Disable Core Dumps</span>
<span class="fn">setrlimit</span>(RLIMIT_CORE, &limit_zero);

<span class="cm">// 3. Anti-Debugging</span>
<span class="fn">ptrace</span>(PTRACE_TRACEME, <span class="num">0</span>, <span class="num">1</span>, <span class="num">0</span>);

<span class="cm">// 4. Verify Dependencies</span>
<span class="fn">verify_dependencies</span>();</div>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Security Property</div>
                        <p>All security checks complete before any cryptographic material enters memory.</p>
                    </div>
                `
            },
            2: {
                title: "GUI Wrapper (Python)",
                tags: [{ text: "Frontend", type: "core" }, { text: "Tkinter", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Role & Limitation</div>
                        <p>The GUI is a convenience wrapper that constructs CLI commands and communicates via standard pipes. It provides a user-friendly interface but inherits Python's memory limitations.</p>
                    </div>
                    <div class="warning-box">
                        <p>‚ö†Ô∏è <strong>Security Warning:</strong> Python strings are immutable. Passwords may persist in heap until GC runs. For paranoid threat models, use the CLI directly.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Startup Notice</div>
                        <p>The GUI displays a one-time security notice explaining these limitations and recommending CLI usage for high-risk operations.</p>
                    </div>
                `
            },
            10: {
                title: "Memory Hygiene Layer",
                tags: [{ text: "Architecture", type: "mem" }, { text: "Anti-Forensics", type: "mem" }],
                content: `
                    <div class="section">
                        <div class="section-title">Philosophy</div>
                        <p>Standard applications trust the OS to manage memory. ThermoCrypt assumes the OS is potentially hostile ‚Äî swap files, crash dumps, and debuggers are all attack vectors.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Components</div>
                        <ul>
                            <li><strong>SodiumAllocator:</strong> Forces physical RAM allocation with guard pages</li>
                            <li><strong>SecretString:</strong> Prevents SSO stack leaks</li>
                            <li><strong>SecureVectorStream:</strong> Zero-copy I/O processing</li>
                            <li><strong>mlock:</strong> Pins memory to prevent swapping</li>
                        </ul>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Guarantee</div>
                        <p>Cryptographic secrets exist in exactly one RAM location, protected by guard pages, and are deterministically wiped.</p>
                    </div>
                `
            },
            11: {
                title: "SodiumAllocator<T>",
                tags: [{ text: "Memory", type: "mem" }, { text: "STL Compliant", type: "mem" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Problem</div>
                        <p>Standard allocators (<code>new</code>, <code>malloc</code>) allocate memory on the standard heap. The OS is free to swap these pages to disk, writing keys in plaintext to the drive ‚Äî recoverable by forensic analysis years later.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">The Solution</div>
                        <div class="code-block"><span class="kw">template</span> <<span class="kw">class</span> T>
T* SodiumAllocator::<span class="fn">allocate</span>(size_t n) {
    <span class="cm">// Pins to RAM, adds guard pages</span>
    <span class="kw">return</span> <span class="fn">sodium_allocarray</span>(n, <span class="kw">sizeof</span>(T));
}

<span class="kw">void</span> <span class="fn">deallocate</span>(T* p, size_t n) {
    <span class="fn">sodium_memzero</span>(p, n * <span class="kw">sizeof</span>(T));
    <span class="fn">sodium_free</span>(p);
}</div>
                    </div>
                `
            },
            12: {
                title: "SecretString",
                tags: [{ text: "SSO Mitigation", type: "mem" }, { text: "Heap Enforcement", type: "mem" }],
                content: `
                    <div class="section">
                        <div class="section-title">The SSO Vulnerability</div>
                        <p>Modern C++ compilers use Small String Optimization ‚Äî strings under ~22 chars are stored on the <strong>stack</strong>, bypassing custom allocators. Stack memory cannot be reliably locked or wiped.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Implementation</div>
                        <div class="code-block"><span class="kw">class</span> SecretString {
    <span class="kw">char</span>* _data;  <span class="cm">// Always heap via sodium_malloc</span>
    
    <span class="kw">explicit</span> <span class="fn">SecretString</span>(<span class="kw">const</span> string& s) {
        _data = <span class="fn">sodium_malloc</span>(s.size() + <span class="num">1</span>);
        <span class="fn">memcpy</span>(_data, s.c_str(), s.size());
    }
    ~<span class="fn">SecretString</span>() { <span class="fn">sodium_free</span>(_data); }
};</div>
                    </div>
                `
            },
            13: {
                title: "SecureVectorStream",
                tags: [{ text: "Zero-Copy", type: "mem" }, { text: "Performance", type: "mem" }],
                content: `
                    <div class="section">
                        <div class="section-title">Zero-Copy Architecture</div>
                        <p>Standard I/O creates multiple copies: <code>Disk ‚Üí Kernel ‚Üí User Buffer ‚Üí String ‚Üí Crypto Buffer</code>. Each copy is a leak opportunity.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">The Stream Wrapper</div>
                        <p><code>SecureVectorStream</code> inherits from <code>std::streambuf</code> and points stream pointers directly at locked memory:</p>
                        <div class="code-block"><span class="cm">// No memcpy ‚Äî the stream IS the memory</span>
<span class="fn">setg</span>(start_ptr, start_ptr, end_ptr);

<span class="cm">// Crypto reads directly from locked RAM</span>
<span class="fn">encrypt_stream_v3</span>(secure_stream, ...);</div>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Impact</div>
                        <p>Plaintext exists in exactly <strong>one</strong> guarded memory region throughout its entire lifecycle.</p>
                    </div>
                `
            },
            14: {
                title: "mlock / VirtualLock",
                tags: [{ text: "Kernel Syscall", type: "mem" }, { text: "Anti-Swap", type: "mem" }],
                content: `
                    <div class="section">
                        <div class="section-title">Preventing Swap</div>
                        <p>When RAM fills, the OS moves pages to disk (swap/pagefile). Forensic analysts can scan these files to recover keys even years after the program closes.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Platform Implementation</div>
                        <ul>
                            <li><strong>Linux:</strong> <code>mlockall(MCL_CURRENT | MCL_FUTURE)</code> locks entire process</li>
                            <li><strong>Windows:</strong> <code>VirtualLock</code> on specific sodium_malloc ranges</li>
                        </ul>
                    </div>
                `
            },
            20: {
                title: "Hybrid Crypto Engine",
                tags: [{ text: "Architecture", type: "crypto" }, { text: "Defense-in-Depth", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">Philosophy</div>
                        <p>ThermoCrypt employs a <strong>Hybrid Key Encapsulation Mechanism</strong>. We assume any single algorithm might fail ‚Äî whether from quantum computers or mathematical breakthroughs.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">The Stack</div>
                        <ul>
                            <li><strong>Post-Quantum:</strong> ML-KEM-768 (Kyber) ‚Äî Quantum-safe lattice-based KEM</li>
                            <li><strong>Classical:</strong> X25519 ‚Äî Battle-tested elliptic curve DH</li>
                            <li><strong>Signature:</strong> ML-DSA-65 (Dilithium) ‚Äî Post-quantum signatures</li>
                            <li><strong>Symmetric:</strong> XChaCha20-Poly1305 ‚Äî AEAD encryption</li>
                            <li><strong>KDF:</strong> Argon2id ‚Äî Memory-hard password hashing</li>
                        </ul>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Guarantee</div>
                        <p>If <em>either</em> Kyber or X25519 remains secure, your messages remain confidential.</p>
                    </div>
                `
            },
            21: {
                title: "ML-KEM-768 (Kyber)",
                tags: [{ text: "Post-Quantum", type: "crypto" }, { text: "NIST FIPS 203", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Algorithm</div>
                        <p>Kyber is a lattice-based Key Encapsulation Mechanism selected by NIST. It relies on the Module Learning With Errors (MLWE) problem ‚Äî believed hard for both classical and quantum computers.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Usage in ThermoCrypt</div>
                        <p>For each message, we generate an <strong>ephemeral</strong> Kyber keypair. The resulting 32-byte shared secret is mixed with X25519's output to derive the final encryption key.</p>
                        <div class="code-block"><span class="fn">OQS_KEM_encaps</span>(kem, ciphertext, shared_secret, recipient_pk);
<span class="cm">// shared_secret = 32 bytes of quantum-safe randomness</span></div>
                    </div>
                `
            },
            22: {
                title: "X25519 (ECDH)",
                tags: [{ text: "Classical", type: "crypto" }, { text: "RFC 7748", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Safety Net</div>
                        <p>X25519 is the industry standard for key exchange ‚Äî used by Signal, SSH, TLS 1.3. It's extremely fast and has withstood decades of cryptanalysis.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Why Include It?</div>
                        <p>If Kyber is broken cryptanalytically next year, X25519 still protects against all classical supercomputers. Defense in depth.</p>
                    </div>
                `
            },
            23: {
                title: "ML-DSA-65 (Dilithium)",
                tags: [{ text: "Digital Signature", type: "crypto" }, { text: "NIST FIPS 204", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">Identity Verification</div>
                        <p>Unlike ephemeral encryption keys, identity keys must persist. Dilithium signs the <code>.thermoid</code> file to prove authenticity.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">MITM Protection</div>
                        <p>When encrypting to "alice", we first verify the Dilithium signature inside <code>alice.thermoid</code>. This ensures keys haven't been tampered with by a man-in-the-middle.</p>
                    </div>
                `
            },
            24: {
                title: "KDF Mix (BLAKE2b)",
                tags: [{ text: "Key Derivation", type: "crypto" }, { text: "Combiner", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Mixing Function</div>
                        <p>Two shared secrets must become one encryption key. We use BLAKE2b (via libsodium's <code>crypto_generichash</code>):</p>
                        <div class="code-block">SS_PQ = <span class="fn">Kyber_Decaps</span>(ciphertext, sk);
SS_CL = <span class="fn">X25519_Scalarmult</span>(eph_pk, sk);

<span class="cm">// The crucial step:</span>
MasterKey = <span class="fn">BLAKE2b</span>(SS_PQ || SS_CL);</div>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Property</div>
                        <p>If either secret remains unknown to the attacker, the MasterKey is computationally indistinguishable from random.</p>
                    </div>
                `
            },
            25: {
                title: "XChaCha20-Poly1305",
                tags: [{ text: "AEAD", type: "crypto" }, { text: "Symmetric", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">Authenticated Encryption</div>
                        <p>Combines confidentiality (ChaCha20 stream cipher) with integrity (Poly1305 MAC). Any tampering causes decryption to fail.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Why XChaCha20?</div>
                        <p>Standard ChaCha20 uses 96-bit nonces ‚Äî random generation risks collisions. <strong>XChaCha20</strong> uses 192-bit nonces, making random generation safe for effectively infinite messages.</p>
                    </div>
                `
            },
            26: {
                title: "Argon2id",
                tags: [{ text: "Password KDF", type: "crypto" }, { text: "RFC 9106", type: "crypto" }],
                content: `
                    <div class="section">
                        <div class="section-title">Memory-Hard Hashing</div>
                        <p>Argon2id derives encryption keys from passwords. It's intentionally slow and memory-intensive, making brute-force attacks impractical even with GPUs or ASICs.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Configuration Levels</div>
                        <ul>
                            <li><strong>interactive:</strong> ~0.5s, 64MB ‚Äî Daily use</li>
                            <li><strong>moderate:</strong> ~1s, 256MB ‚Äî Sensitive data</li>
                            <li><strong>sensitive:</strong> ~3s, 1GB ‚Äî High-value secrets</li>
                        </ul>
                    </div>
                `
            },
            30: {
                title: "Secure I/O Layer",
                tags: [{ text: "Abstraction", type: "io" }, { text: "File Safety", type: "io" }],
                content: `
                    <div class="section">
                        <div class="section-title">Purpose</div>
                        <p>Abstracts file operations to prevent race conditions, symlink attacks, and permission vulnerabilities.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">v2.1.0 Improvements</div>
                        <ul>
                            <li><strong>read_file_secure:</strong> O_NOFOLLOW + fstat on FD</li>
                            <li><strong>write_file_secure:</strong> O_CREAT|O_EXCL + atomic permissions</li>
                            <li><strong>read_stdin_limited:</strong> DoS protection with size limits</li>
                        </ul>
                    </div>
                `
            },
            31: {
                title: "TOCTOU Defense",
                tags: [{ text: "Race Condition", type: "io" }, { text: "Kernel", type: "io" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Attack</div>
                        <p>Time-Of-Check to Time-Of-Use: An attacker swaps a file with a symlink to <code>/etc/passwd</code> between your existence check and your file open.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Linux Mitigation</div>
                        <div class="code-block"><span class="cm">// Read: Atomic symlink rejection</span>
<span class="kw">int</span> fd = <span class="fn">open</span>(path, O_RDONLY | O_NOFOLLOW);
<span class="fn">fstat</span>(fd, &st);  <span class="cm">// Verify on FD, not path</span>

<span class="cm">// Write: Exclusive creation</span>
<span class="kw">int</span> fd = <span class="fn">open</span>(path, O_WRONLY | O_CREAT | O_EXCL | O_NOFOLLOW, <span class="num">0600</span>);
<span class="fn">fsync</span>(fd);  <span class="cm">// Ensure data hits disk</span></div>
                    </div>
                `
            },
            32: {
                title: "ASCII Armor",
                tags: [{ text: "Encoding", type: "io" }, { text: "Transport", type: "io" }],
                content: `
                    <div class="section">
                        <div class="section-title">PGP-Compatible Format</div>
                        <p>Binary ciphertext is Base64 encoded and wrapped in headers for safe text transport:</p>
                        <div class="code-block">-----BEGIN THERMO MESSAGE-----
hQIMA2B4...base64...
-----END THERMO MESSAGE-----</div>
                    </div>
                    <div class="section">
                        <div class="section-title">Use Cases</div>
                        <p>Copy/paste via email, Signal, forums, or any text medium without encoding corruption.</p>
                    </div>
                `
            },
            33: {
                title: "Identity File (.thermoid)",
                tags: [{ text: "File Format", type: "io" }, { text: "Public", type: "io" }],
                content: `
                    <div class="section">
                        <div class="section-title">Structure</div>
                        <p>A self-contained certificate containing all public keys and proof of authenticity:</p>
                        <ul>
                            <li>Magic: <code>THERMO_V1</code></li>
                            <li>ML-KEM-768 Public Key</li>
                            <li>X25519 Public Key</li>
                            <li>ML-DSA-65 Public Key</li>
                            <li><strong>Signature:</strong> Dilithium signature over all fields</li>
                        </ul>
                    </div>
                `
            },
            34: {
                title: "Vault File (.vault)",
                tags: [{ text: "File Format", type: "io" }, { text: "Private", type: "io" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Secrets Container</div>
                        <p>Contains private keys in a double-layer encryption scheme:</p>
                        <ol>
                            <li><strong>Inner:</strong> Private keys encrypted with random DEK + XChaCha20</li>
                            <li><strong>Outer (Seal):</strong> DEK encrypted via Argon2id (password) or TPM (hardware)</li>
                        </ol>
                    </div>
                    <div class="section">
                        <div class="section-title">TOCTOU Protection</div>
                        <p>Written via <code>write_file_secure()</code> with atomic creation and 0600 permissions.</p>
                    </div>
                `
            },
            40: {
                title: "Generate Identity",
                tags: [{ text: "Workflow", type: "core" }, { text: "--gen", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Execution Flow</div>
                        <ol>
                            <li>Prompt for password</li>
                            <li><strong>Validate password policy</strong> (min 8 chars, complexity)</li>
                            <li>Generate Kyber + X25519 + Dilithium keypairs</li>
                            <li>Sign public keys with Dilithium</li>
                            <li>Generate random 32-byte DEK in locked RAM</li>
                            <li>Encrypt private keys with DEK</li>
                            <li>Seal DEK (Argon2id or TPM)</li>
                            <li>Write via <code>write_file_secure()</code> (atomic)</li>
                            <li>Wipe all memory</li>
                        </ol>
                    </div>
                `
            },
            41: {
                title: "TPM Binding",
                tags: [{ text: "Hardware", type: "core" }, { text: "Linux Only", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Key Sealing</div>
                        <p>The DEK is sent to the TPM 2.0 chip for encryption using its Storage Root Key. The Kyber keys stay in software (too large for TPM).</p>
                    </div>
                    <div class="section">
                        <div class="section-title">v2.1.0: Dynamic Slots</div>
                        <p>Supports 256 TPM slots (0x81018100 - 0x810181FF) for multiple identities:</p>
                        <div class="code-block">./thermo_core --gen alice --bind tpm
./thermo_core --gen bob --bind tpm --tpm-slot <span class="num">1</span></div>
                    </div>
                    <div class="security-box">
                        <div class="label">üõ°Ô∏è Property</div>
                        <p>Private keys cannot be decrypted on any other physical machine.</p>
                    </div>
                `
            },
            42: {
                title: "Encrypt Message",
                tags: [{ text: "Workflow", type: "core" }, { text: "--encrypt-armor", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Execution Flow</div>
                        <ol>
                            <li>Read <code>recipient.thermoid</code></li>
                            <li>Verify Dilithium signature</li>
                            <li><strong>Check input size</strong> (max 64 MB)</li>
                            <li>Stream stdin via <code>SecureVectorStream</code></li>
                            <li>Generate ephemeral Kyber + X25519 pairs</li>
                            <li>Derive shared secrets and mix to MasterKey</li>
                            <li>Encrypt with XChaCha20-Poly1305</li>
                            <li>Output ASCII Armor</li>
                            <li>Wipe memory</li>
                        </ol>
                    </div>
                `
            },
            43: {
                title: "Decrypt Message",
                tags: [{ text: "Workflow", type: "core" }, { text: "--decrypt-armor", type: "core" }],
                content: `
                    <div class="section">
                        <div class="section-title">Execution Flow</div>
                        <ol>
                            <li>Read vault via <code>read_file_secure()</code></li>
                            <li>Prompt for password (or send blob to TPM)</li>
                            <li>Derive KEK with Argon2id</li>
                            <li>Decrypt DEK and private keys</li>
                            <li>Parse ASCII Armor (with size limit)</li>
                            <li>Decapsulate Kyber + X25519 secrets</li>
                            <li>Re-derive MasterKey</li>
                            <li>Decrypt and verify Poly1305 tag</li>
                            <li>Output plaintext to stdout</li>
                        </ol>
                    </div>
                `
            },
            50: {
                title: "Security Policies",
                tags: [{ text: "v2.1.0", type: "security" }, { text: "Hardening", type: "security" }],
                content: `
                    <div class="section">
                        <div class="section-title">New in v2.1.0</div>
                        <p>Centralized security policy enforcement layer, addressing audit findings:</p>
                        <ul>
                            <li><strong>Password Policy:</strong> Minimum length and complexity checks</li>
                            <li><strong>DoS Protection:</strong> Input size limits prevent memory exhaustion</li>
                            <li><strong>Dependency Verification:</strong> Runtime checks for required algorithms</li>
                        </ul>
                    </div>
                `
            },
            51: {
                title: "Password Policy",
                tags: [{ text: "CWE-521", type: "security" }, { text: "Input Validation", type: "security" }],
                content: `
                    <div class="section">
                        <div class="section-title">Enforcement</div>
                        <p>Prevents weak passwords that undermine Argon2id's protection:</p>
                        <div class="code-block"><span class="kw">if</span> (password.length() < MIN_PASSWORD_LENGTH) {
    <span class="kw">throw</span> <span class="fn">runtime_error</span>(<span class="str">"Minimum 8 chars required"</span>);
}

<span class="cm">// Trivial password check (all same char)</span>
<span class="kw">if</span> (is_trivial(password)) {
    <span class="kw">throw</span> <span class="fn">runtime_error</span>(<span class="str">"Use different characters"</span>);
}</div>
                    </div>
                `
            },
            52: {
                title: "DoS Protection",
                tags: [{ text: "CWE-400", type: "security" }, { text: "Resource Limits", type: "security" }],
                content: `
                    <div class="section">
                        <div class="section-title">The Threat</div>
                        <p>Unbounded stdin reads could exhaust memory with malicious input, crashing the process or the system.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Mitigation</div>
                        <div class="code-block"><span class="kw">const</span> size_t MAX_MESSAGE_SIZE = <span class="num">64</span> * <span class="num">1024</span> * <span class="num">1024</span>;

<span class="kw">while</span> (cin.<span class="fn">get</span>(c)) {
    <span class="kw">if</span> (plaintext.<span class="fn">size</span>() >= MAX_MESSAGE_SIZE) {
        <span class="kw">throw</span> <span class="fn">runtime_error</span>(<span class="str">"Input too large"</span>);
    }
    plaintext.<span class="fn">push_back</span>(c);
}</div>
                    </div>
                `
            },
            53: {
                title: "Dependency Verification",
                tags: [{ text: "Startup", type: "security" }, { text: "Fail-Fast", type: "security" }],
                content: `
                    <div class="section">
                        <div class="section-title">Purpose</div>
                        <p>Ensures required cryptographic algorithms are available before any operations, preventing cryptic runtime errors.</p>
                    </div>
                    <div class="section">
                        <div class="section-title">Implementation</div>
                        <div class="code-block"><span class="kw">void</span> <span class="fn">verify_dependencies</span>() {
    <span class="kw">if</span> (!<span class="fn">OQS_KEM_alg_is_enabled</span>(<span class="str">"ML-KEM-768"</span>)) {
        <span class="kw">throw</span> <span class="fn">runtime_error</span>(<span class="str">"Kyber not available"</span>);
    }
    <span class="kw">if</span> (!<span class="fn">OQS_SIG_alg_is_enabled</span>(<span class="str">"ML-DSA-65"</span>)) {
        <span class="kw">throw</span> <span class="fn">runtime_error</span>(<span class="str">"Dilithium not available"</span>);
    }
}</div>
                    </div>
                `
            }
        };

        // === NETWORK CONFIGURATION ===
        const container = document.getElementById("network");
        const options = {
            nodes: {
                shape: "dot",
                size: 26,
                font: { size: 14, color: "#e8edf4", face: "Inter" },
                borderWidth: 2,
                shadow: { enabled: true, color: "rgba(0,0,0,0.5)", size: 10, x: 0, y: 5 },
                margin: 12
            },
            edges: {
                width: 1.5,
                length: 280,
                color: { color: "#2a3a4a", highlight: "#00d4ff", hover: "#00d4ff" },
                smooth: { type: "continuous", roundness: 0.2 },
                font: { size: 10, color: "#5a6a7e", align: "middle" }
            },
            groups: {
                mem: { color: { background: "#1a1215", border: "#ff4757" }, font: { color: "#ff6b7a" } },
                crypto: { color: { background: "#15121a", border: "#9c5fff" }, font: { color: "#b794ff" } },
                io: { color: { background: "#0f1a12", border: "#00d26a" }, font: { color: "#5fffab" } },
                core: { color: { background: "#1a1510", border: "#ffb347" }, font: { color: "#ffc978" } },
                security: { color: { background: "#1a1218", border: "#ff6b9d" }, font: { color: "#ff8fb3" } }
            },
            interaction: {
                hover: true,
                tooltipDelay: 50,
                zoomView: true,
                dragView: true
            },
            physics: {
                stabilization: { iterations: 200, fit: true },
                barnesHut: {
                    gravitationalConstant: -8000,
                    centralGravity: 0.1,
                    springLength: 250,
                    springConstant: 0.01,
                    damping: 0.4,
                    avoidOverlap: 1
                },
                minVelocity: 0.75
            }
        };

        const network = new vis.Network(container, { nodes, edges }, options);
        const panel = document.getElementById("details-panel");
        const introMsg = document.getElementById("intro-msg");
        const detailView = document.getElementById("detail-view");

        // === INTERACTION ===
        function openPanel() { panel.classList.add("open"); }
        function closePanel() { panel.classList.remove("open"); network.unselectAll(); }

        function showDetail(nodeId) {
            const info = detailsMap[nodeId];
            if (!info) {
                const label = nodes.get(nodeId)?.label?.replace("\n", " ") || "Unknown";
                document.getElementById("detail-title").textContent = label;
                document.getElementById("detail-tags").innerHTML = '';
                document.getElementById("detail-body").innerHTML = '<div class="section"><p>Documentation for this component is in progress.</p></div>';
            } else {
                document.getElementById("detail-title").textContent = info.title;
                document.getElementById("detail-tags").innerHTML = info.tags.map(t => 
                    `<span class="tag tag-${t.type}">${t.text}</span>`
                ).join('');
                document.getElementById("detail-body").innerHTML = info.content;
            }
            introMsg.style.display = "none";
            detailView.style.display = "block";
            openPanel();
        }

        network.on("click", params => {
            if (params.nodes.length > 0) {
                showDetail(params.nodes[0]);
            }
        });

        network.once("afterDrawing", () => {
            network.fit({ animation: { duration: 800, easingFunction: "easeOutQuad" } });
        });
    </script>
</body>
</html>